FROM node:18-alpine AS builder

# 安装 pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /usr/src/app

# 复制依赖文件
COPY package.json pnpm-lock.yaml* ./

# 安装依赖（包括 devDependencies，用于构建）
RUN pnpm install --frozen-lockfile

# 复制源代码并构建
COPY . .
RUN pnpm run build

# 生产阶段
FROM node:18-alpine AS production

# 安装 pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /usr/src/app

# 设置环境变量
ENV NODE_ENV=production

# 复制依赖文件
COPY package.json pnpm-lock.yaml* ./

# 只安装生产依赖
RUN pnpm install --frozen-lockfile --prod && \
    pnpm store prune

# 从构建阶段复制构建产物
COPY --from=builder /usr/src/app/dist ./dist

EXPOSE 3000

CMD ["node", "dist/main.js"]